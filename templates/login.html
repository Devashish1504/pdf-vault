{% extends "index.html" %}

{% block content %}
<div class="card">
    <h2>Sign In</h2>
    <p>Sign in to manage your PDF files securely.</p>

    <div id="clerk-container"></div>

    <p style="margin-top: 20px; color: var(--muted);">
        Or continue as <a href="/">Guest</a> (files won't be saved permanently)
    </p>
</div>

<script async crossorigin="anonymous" data-clerk-publishable-key="{{ clerk_key }}"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>

<script>
    window.addEventListener('load', async () => {
        await Clerk.load();

        if (Clerk.user) {
            // User is signed in, send to backend
            const response = await fetch('/auth/callback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: Clerk.user.id,
                    email: Clerk.user.primaryEmailAddress?.emailAddress || '',
                    name: Clerk.user.fullName || Clerk.user.firstName || 'User'
                })
            });

            if (response.ok) {
                window.location.href = '/';
            }
        } else {
            // Mount sign-in component
            Clerk.mountSignIn(document.getElementById('clerk-container'), {
                afterSignInUrl: '/login',
                afterSignUpUrl: '/login'
            });
        }
    });
</script>
{% endblock %}